---
title: 节点高负载排障处理
date: 2022-01-07 20:10:53
tags: 
- k8s
- pod
---

本文档介绍如何在 TKE 集群中，通过工具定位异常是否由高负载造成，请按照以下步骤进行问题排查。
<!--more-->

## 现象描述

节点高负载将会导致进程无法获得足够运行所需的 CPU 时间片，通常表现为网络 Timeout、健康检查失败或服务不可用。

## 问题定位及解决思路

有时节点在低 cpu ‘us’ (user) 、高 cpu ‘id’ (idle) 的条件下，仍会出现负载很高的情况。通常是由于文件 IO 性能达到瓶颈，导致 IO Wait 过多，使节点整体负载升高，影响其它进程的性能。
本文以 top、atop 及 iotop 工具为例，来判断磁盘 I/O 是否正在降低应用性能。

### 查看平均负载及等待时间

1. 登录节点，执行 top 命令查看当前负载。结果说明如下：
   可通过较高的 load average 值得知该节点正在承接大量的请求，也可以通过 Cpu(s)、Mem、%CPU 及 %MEM 列的数据获取哪些进程正在占用大多数资源。
2. 在返回结果界面，可查看核的 wa 值，wa（wait）表示 IO WAIT 的 CPU 占用。默认显示所有核的平均值，按1查看每个核的 wa 值。
   wa 通常为0%，如果经常浮动在1%之上，说明存储设备的速度已经太慢，无法跟上 CPU 的处理速度。

### 监视磁盘 IO 统计信息

1. 执行命令 atop ，查看当前磁盘 IO 状态。例如，磁盘 sda 显示 busy 100% ，表示已达到严重性能瓶颈。
2. 查看占用磁盘 IO 的进程，有如下两种方法：
   - 继续在该界面按 d，可查看哪些进程正在使用磁盘 IO。
   - 也可以执行命令 iotop -oPa 查看哪些进程占用磁盘 IO。
   - 通过 man iotop 命令可以查看以下几个参数的含义。

## 其它原因

节点上部署了其他非 K8S 管理的服务可能造成节点高负载问题。例如，在节点上安装不被 K8S 所管理的数据库。



