---
title: mysql的行列操作
date: 2017-12-28 16:50:13
tags:
  - sql
---

使用 mysql 的关联对数据进行一个行列操作

<!--more-->

1、使用 case...when....then 进行行转列

```sql
SELECT userid,
SUM(CASE `subject` WHEN '语文' THEN score ELSE 0 END) as '语文',
SUM(CASE `subject` WHEN '数学' THEN score ELSE 0 END) as '数学',
SUM(CASE `subject` WHEN '英语' THEN score ELSE 0 END) as '英语',
SUM(CASE `subject` WHEN '政治' THEN score ELSE 0 END) as '政治'
FROM tb_score
GROUP BY userid
```

2、使用 IF() 进行行转列：

```sql
SELECT userid,
SUM(IF(`subject`='语文',score,0)) as '语文',
SUM(IF(`subject`='数学',score,0)) as '数学',
SUM(IF(`subject`='英语',score,0)) as '英语',
SUM(IF(`subject`='政治',score,0)) as '政治'
FROM tb_score
GROUP BY userid
```

注意点：

（1）SUM() 是为了能够使用 GROUP BY 根据 userid 进行分组，因为每一个 userid 对应的 subject="语文"的记录只有一条，所以 SUM() 的值就等于对应那一条记录的 score 的值。

假如 userid ='001' and subject='语文' 的记录有两条，则此时 SUM() 的值将会是这两条记录的和，同理，使用 Max()的值将会是这两条记录里面值最大的一个。但是正常情况下，一个 user 对应一个 subject 只有一个分数，因此可以使用 SUM()、MAX()、MIN()、AVG()等聚合函数都可以达到行转列的效果。

（2）IF(subject='语文',score,0) 作为条件，即对所有 subject='语文'的记录的 score 字段进行 SUM()、MAX()、MIN()、AVG()操作，如果 score 没有值则默认为 0。

3、利用 SUM(IF()) 生成列 + WITH ROLLUP 生成汇总行,并利用 IFNULL 将汇总行标题显示为 Total

```sql
SELECT IFNULL(userid,'total') AS userid,
SUM(IF(`subject`='语文',score,0)) AS 语文,
SUM(IF(`subject`='数学',score,0)) AS 数学,
SUM(IF(`subject`='英语',score,0)) AS 英语,
SUM(IF(`subject`='政治',score,0)) AS 政治,
SUM(IF(`subject`='total',score,0)) AS total
FROM(
    SELECT userid,IFNULL(`subject`,'total') AS `subject`,SUM(score) AS score
    FROM tb_score
    GROUP BY userid,`subject`
    WITH ROLLUP
    HAVING userid IS NOT NULL
)AS A
GROUP BY userid
WITH ROLLUP;
```

# 列转行

```sql
SELECT userid,'语文' AS course,cn_score AS score FROM tb_score1
UNION ALL
SELECT userid,'数学' AS course,math_score AS score FROM tb_score1
UNION ALL
SELECT userid,'英语' AS course,en_score AS score FROM tb_score1
UNION ALL
SELECT userid,'政治' AS course,po_score AS score FROM tb_score1
ORDER BY userid
```

这里将每个 userid 对应的多个科目的成绩查出来，通过 UNION ALL 将结果集加起来，达到上图的效果。

附：UNION 与 UNION ALL 的区别（摘）：

1.对重复结果的处理：UNION 会去掉重复记录，UNION ALL 不会；

2.对排序的处理：UNION 会排序，UNION ALL 只是简单地将两个结果集合并；

3.效率方面的区别：因为 UNION 会做去重和排序处理，因此效率比 UNION ALL 慢很多；
